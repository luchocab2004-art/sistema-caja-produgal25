<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Caja - DUXELITOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', Arial, sans-serif; 
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #90CAF9 100%); 
            min-height: 100vh; 
        }
        
        .login-screen { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            background: linear-gradient(135deg, #0F2847 0%, #1565C0 40%, #42A5F5 100%); 
        }
        .login-box { 
            background: white; 
            padding: 50px 40px; 
            border-radius: 20px; 
            box-shadow: 0 15px 60px rgba(0,0,0,0.4); 
            width: 100%; 
            max-width: 500px; 
            text-align: center; 
        }
        .logo-box { margin-bottom: 35px; }
        .logo-box img { max-width: 100%; height: auto; max-height: 180px; border-radius: 10px; }
        .login-box h2 { 
            color: #1565C0; 
            margin-bottom: 35px; 
            font-size: 28px; 
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .login-box input { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 18px; 
            border: 2px solid #ddd; 
            border-radius: 10px; 
            font-size: 15px; 
            font-family: 'Poppins', Arial, sans-serif;
            transition: all 0.3s;
        }
        .login-box input:focus {
            outline: none;
            border-color: #1565C0;
            box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
        }
        .login-box button { 
            width: 100%; 
            padding: 16px; 
            background: linear-gradient(135deg, #1565C0 0%, #42A5F5 100%); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            letter-spacing: 0.5px;
            font-family: 'Poppins', Arial, sans-serif;
        }
        .login-box button:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(21, 101, 192, 0.5); 
        }
        
        .main-app { display: none; min-height: 100vh; background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #90CAF9 100%); }
        .header { 
            background: linear-gradient(135deg, #1565C0 0%, #1976D2 50%, #42A5F5 100%); 
            padding: 30px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        .header-left { display: flex; align-items: center; gap: 25px; color: white; }
        .header-logo { max-width: 120px; max-height: 110px; border-radius: 8px; }
        .header-left h1 { 
            font-size: 22px; 
            margin: 0; 
            font-weight: 600; 
            letter-spacing: 0.5px;
        }
        .header-left p { 
            font-size: 13px; 
            opacity: 0.95; 
            margin-top: 6px; 
            line-height: 1.6; 
            font-weight: 400;
        }
        .header-right { display: flex; gap: 12px; }
        .btn { 
            padding: 11px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 13px; 
            transition: all 0.3s;
            font-family: 'Poppins', Arial, sans-serif;
            letter-spacing: 0.3px;
        }
        .btn-backup { background: #4CAF50; color: white; }
        .btn-load { background: #2196F3; color: white; }
        .btn-logout { background: #f44336; color: white; }
        .btn:hover { opacity: 0.85; transform: translateY(-2px); }
        
        .tabs { 
            background: white; 
            padding: 0 40px; 
            display: flex; 
            gap: 40px; 
            border-bottom: 3px solid #1565C0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .tab { 
            background: none; 
            border: none; 
            color: #666; 
            cursor: pointer; 
            font-weight: 500; 
            padding: 20px 0; 
            border-bottom: 4px solid transparent; 
            transition: all 0.3s; 
            font-size: 17px; 
            font-family: 'Poppins', Arial, sans-serif;
            letter-spacing: 0.3px;
        }
        .tab.active { 
            color: #1565C0; 
            border-bottom-color: #1565C0; 
            font-weight: 600; 
        }
        .tab:hover { color: #1565C0; }
        
        .content { padding: 30px 40px; max-width: 1600px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .fecha-box { 
            background: white; 
            padding: 22px 25px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            border-left: 6px solid #1565C0; 
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
        }
        .fecha-box label { 
            color: #1565C0; 
            font-weight: 600; 
            display: block; 
            margin-bottom: 10px; 
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        .fecha-box input { 
            padding: 12px; 
            border: 2px solid #1565C0; 
            border-radius: 8px; 
            width: 100%; 
            font-family: 'Poppins', Arial, sans-serif;
            font-size: 14px;
        }
        
        .grid-2 { display: grid; grid-template-columns: 1fr; gap: 25px; margin-bottom: 25px; }
        .card { 
            background: white; 
            padding: 28px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        .card h3 { 
            color: #1565C0; 
            margin-bottom: 20px; 
            font-size: 20px; 
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 18px; table-layout: fixed; }
        th { 
            background: #E3F2FD; 
            padding: 14px 12px; 
            text-align: left; 
            font-weight: 600; 
            color: #1565C0; 
            border-bottom: 3px solid #1565C0; 
            font-size: 13px;
            letter-spacing: 0.3px;
        }
        th:nth-child(1) { width: 40%; }
        th:nth-child(2) { width: 25%; }
        th:nth-child(3) { width: 15%; }
        th:nth-child(4) { width: 15%; }
        th:nth-child(5) { width: 5%; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; word-break: break-word; }
        td:nth-child(1) { width: 40%; }
        td:nth-child(2) { width: 25%; }
        td:nth-child(3) { width: 15%; }
        td:nth-child(4) { width: 15%; }
        td:nth-child(5) { width: 5%; }
        
        select, input[type="text"], input[type="number"] { 
            width: 100%; 
            padding: 11px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px; 
            font-family: 'Poppins', Arial, sans-serif;
            transition: all 0.3s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #1565C0;
        }
        input[type="date"] { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-family: 'Poppins', Arial, sans-serif;
        }
        
        .tipo-search { 
            width: 100% !important; 
            padding: 11px !important; 
            border: 2px solid #ddd !important; 
            border-radius: 8px !important; 
            font-size: 14px !important; 
            font-family: 'Poppins', Arial, sans-serif !important;
        }
        .tipo-select { 
            width: 100%; 
            padding: 11px; 
            border: 2px solid #1565C0; 
            border-radius: 8px; 
            max-height: 150px; 
            overflow-y: auto; 
            position: relative; 
            z-index: 10; 
        }
        
        .total-box { 
            color: white; 
            padding: 18px 22px; 
            border-radius: 10px; 
            display: flex; 
            justify-content: space-between; 
            margin-top: 18px; 
            font-weight: 600; 
            font-size: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            letter-spacing: 0.3px;
        }
        .total-ingresos { background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); }
        .total-egresos { background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); }
        .total-box.ingresos { background: linear-gradient(135deg, #388e3c 0%, #4caf50 100%); }
        .total-box.egresos { background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%); }
        
        .btn-add { 
            background: #1565C0; 
            color: white; 
            border: none; 
            padding: 12px 22px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            margin-right: 12px; 
            transition: all 0.3s;
            font-family: 'Poppins', Arial, sans-serif;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        .btn-add:hover { 
            background: #0d47a1; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.4);
        }
        .btn-custom { 
            background: #7cb342; 
            color: white; 
            border: none; 
            padding: 12px 22px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s;
            font-family: 'Poppins', Arial, sans-serif;
            font-size: 14px;
            margin-right: 8px;
            letter-spacing: 0.3px;
        }
        .btn-custom:hover { 
            opacity: 0.9; 
            transform: translateY(-2px);
        }
        .btn-remove { 
            background: #f44336; 
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 600;
            transition: all 0.3s;
            font-family: 'Poppins', Arial, sans-serif;
        }
        .btn-remove:hover { 
            background: #d32f2f; 
            transform: scale(1.05);
        }
        
        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 35px; }
        .summary-card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            transition: all 0.3s;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .summary-card .label { 
            color: #999; 
            font-size: 13px; 
            font-weight: 600; 
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .summary-card .value { 
            color: #1565C0; 
            font-size: 32px; 
            font-weight: 700; 
            margin-top: 12px; 
        }
        .summary-card.highlight { 
            background: linear-gradient(135deg, #1565C0 0%, #42A5F5 100%); 
        }
        .summary-card.highlight .label { color: rgba(255,255,255,0.9); }
        .summary-card.highlight .value { color: white; }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.6); 
            justify-content: center; 
            align-items: center; 
            z-index: 10000;
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: white; 
            padding: 35px; 
            border-radius: 15px; 
            max-width: 450px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-content h3 { 
            color: #1565C0; 
            margin-bottom: 20px; 
            font-size: 22px; 
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .modal-content input, .modal-content select { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 18px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-family: 'Poppins', Arial, sans-serif;
            font-size: 14px;
        }
        .modal-buttons { display: flex; gap: 12px; margin-top: 10px; }
        .modal-buttons button { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s;
            font-family: 'Poppins', Arial, sans-serif;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        .btn-confirm { background: #1565C0; color: white; }
        .btn-confirm:hover { background: #0d47a1; transform: translateY(-2px); }
        .btn-cancel { background: #f0f0f0; color: #333; }
        .btn-cancel:hover { background: #e0e0e0; }
        
        .tipo-wrapper { position: relative; }
        .tipo-search { 
            width: 100% !important; 
            padding: 12px !important; 
            border: 2px solid #ddd !important; 
            border-radius: 8px !important; 
            font-size: 14px !important; 
            background: white !important; 
            color: #333 !important; 
            font-family: 'Poppins', Arial, sans-serif !important;
        }
        .tipo-search::placeholder { color: #999 !important; }
        .tipo-dropdown { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 2px solid #1565C0; 
            border-top: none; 
            border-radius: 0 0 8px 8px; 
            max-height: 220px; 
            overflow-y: auto; 
            z-index: 1000; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.2); 
        }
        .tipo-item { 
            padding: 12px 14px; 
            cursor: pointer; 
            border-bottom: 1px solid #f0f0f0; 
            font-size: 13px; 
            transition: all 0.2s; 
            color: #333; 
            font-family: 'Poppins', Arial, sans-serif;
        }
        .tipo-item:hover { 
            background: #E3F2FD; 
            color: #1565C0; 
            font-weight: 500; 
        }
        .tipo-item-empty { 
            padding: 12px 14px; 
            color: #999; 
            font-style: italic; 
            text-align: center; 
        }
        
        @media (max-width: 1024px) { 
            .grid-2 { grid-template-columns: 1fr; } 
            .summary { grid-template-columns: repeat(2, 1fr); } 
        }
        @media (max-width: 768px) { 
            .header { flex-direction: column; gap: 15px; padding: 20px; } 
            .tabs { flex-wrap: wrap; padding: 0 20px; } 
            .summary { grid-template-columns: 1fr; } 
            .header-right { width: 100%; flex-wrap: wrap; } 
            .content { padding: 20px; }
        }
        
        #reporteContainer table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        #reporteContainer th { 
            background: #1565C0; 
            color: white; 
            padding: 14px; 
            text-align: left; 
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.3px;
        }
        #reporteContainer td { padding: 12px; border-bottom: 1px solid #ddd; }
        #reporteContainer tr:hover { background: #f5f5f5; }
        #reporteContainer h3 { 
            color: #1565C0; 
            margin: 25px 0 15px 0; 
            font-size: 20px; 
            font-weight: 600;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="logo-box">
                <img src="https://i.postimg.cc/hG997yWv/preview-(5).jpg" alt="Duxelitos">
            </div>
            <h2>Sistema de Caja Diaria</h2>
            <button id="btnLogin">INGRESAR AL SISTEMA</button>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="header">
            <div class="header-left">
                <img src="https://i.postimg.cc/hG997yWv/preview-(5).jpg" alt="Duxelitos" class="header-logo">
                <div>
                    <h1>SISTEMA DE CAJA DIARIA</h1>
                    <p style="font-size: 13px; margin-top: 8px; line-height: 1.6;">
                        <strong>PRODUGAL S.R.L. - DUXELITOS</strong><br>
                        üìç Av. Pedro Vargas 2400 - San Rafael, Mendoza<br>
                        üì± 2604-599915 | üìß ventas@dulxelitos.com.ar | üè¢ CUIT: 30-71753073-6
                    </p>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-backup" id="btnBackup">üíæ Backup</button>
                <button class="btn btn-load" id="btnLoadBackup">üìÇ Cargar</button>
                <button class="btn" style="background: #4CAF50; color: white;" onclick="exportarExcelCaja()">üìä Excel</button>
                <button class="btn btn-logout" id="btnLogout">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="caja">Caja Diaria</button>
            <button class="tab" data-tab="reportes">Reportes</button>
        </div>

        <div class="content">
            <div class="tab-content active" id="tabCaja">
                <div class="fecha-box">
                    <label>Fecha de Operaci√≥n</label>
                    <input type="date" id="fecha">
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3>üí∞ Ingresos</h3>
                        <table>
                            <thead><tr><th>Tipo de Ingreso</th><th>Detalle</th><th>Efectivo</th><th>Transfer.</th><th></th></tr></thead>
                            <tbody id="ingresosBody"></tbody>
                        </table>
                        <button class="btn-add" onclick="addIngreso()">+ Agregar Ingreso</button>
                        <button class="btn-custom" onclick="openNewType('ingreso')">‚ûï Nuevo Tipo</button>
                        <button class="btn-custom" style="background: #f44336;" onclick="openDeleteType('ingreso')">‚ûñ Eliminar Tipo</button>
                        <div class="total-box total-ingresos">
                            <span>Total Ingresos:</span>
                            <span><span id="totalIngresos">$0</span></span>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üí∏ Egresos</h3>
                        <table>
                            <thead><tr><th>Tipo de Egreso</th><th>Detalle</th><th>Efectivo</th><th>Transfer.</th><th></th></tr></thead>
                            <tbody id="egresosBody"></tbody>
                        </table>
                        <button class="btn-add" onclick="addEgreso()">+ Agregar Egreso</button>
                        <button class="btn-custom" onclick="openNewType('egreso')">‚ûï Nuevo Tipo</button>
                        <button class="btn-custom" style="background: #f44336;" onclick="openDeleteType('egreso')">‚ûñ Eliminar Tipo</button>
                        <div class="total-box total-egresos">
                            <span>Total Egresos:</span>
                            <span><span id="totalEgresos">$0</span></span>
                        </div>
                    </div>
                </div>

                <div class="summary">
                    <div class="summary-card">
                        <div class="label">Total Ingresos</div>
                        <div class="value"><span id="resumenIngresos">$0</span></div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Total Egresos</div>
                        <div class="value"><span id="resumenEgresos">$0</span></div>
                    </div>
                    <div class="summary-card">
                        <div class="label">Transferencias</div>
                        <div class="value"><span id="resumenTransferencias">$0</span></div>
                    </div>
                    <div class="summary-card highlight">
                        <div class="label">Efectivo en Caja</div>
                        <div class="value"><span id="efectivoFinal">$0</span></div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tabReportes">
                <div style="background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h3 style="color: #1565C0; margin-bottom: 20px; font-size: 20px; font-weight: 600;">üìä Generar Reporte de Per√≠odo</h3>
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <strong style="color: #1565C0;">Desde:</strong> 
                            <input type="date" id="fechaDesde" style="padding: 10px; border: 2px solid #1565C0; border-radius: 8px; font-family: 'Poppins', Arial, sans-serif;">
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <strong style="color: #1565C0;">Hasta:</strong> 
                            <input type="date" id="fechaHasta" style="padding: 10px; border: 2px solid #1565C0; border-radius: 8px; font-family: 'Poppins', Arial, sans-serif;">
                        </label>
                        <button class="btn-add" onclick="generarReporte()">üìã Generar Reporte</button>
                        <button class="btn-custom" style="background: #4CAF50;" onclick="exportarExcelReportes()">üìä Descargar Excel</button>
                    </div>
                </div>
                <div id="reporteContainer" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <p style="text-align: center; color: #999; font-size: 15px;">Selecciona un rango de fechas y genera un reporte</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="newTypeModal">
        <div class="modal-content">
            <h3 id="modalTitle">Crear Nuevo Tipo</h3>
            <input type="text" id="newTypeName" placeholder="Nombre del tipo">
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="crearNuevoTipo()">Crear</button>
                <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteTypeModal">
        <div class="modal-content">
            <h3 id="modalDeleteTitle">Eliminar Tipo</h3>
            <select id="deleteTypeSelect">
                <option value="">-- Seleccionar tipo a eliminar --</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="eliminarTipo()" style="background: #f44336;">Eliminar</button>
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        var tiposIngreso = ["Aporte en Dinero", "Cobranza Valentin", "Factura", "Factura Pago a Cuenta", "Factura Transferencia", "Recupero Cheque", "Remito", "Remito Pago a Cuenta", "Remito Transferencia", "Cobranza Andres", "Exedente de Caja", "Otros Ingresos", "Cobranza Dist. Chinarro", "Recupero de Gasto", "Inicio de Caja"];
        var tiposEgreso = ["Ajuste de Sueldo Alcala Marcelo", "Ajuste de Sueldo Bayona Walter", "Ajuste de Sueldo Castilla Ezequiel", "Ajuste de Sueldo Castilla Luciano", "Ajuste de Sueldo Cayo Nestor", "Ajuste de Sueldo Gijon Valentin", "Ajuste de Sueldo Huberman Cesar", "Ajuste de Sueldo Lozada David", "Ajuste de Sueldo Lozada Marcela", "Ajuste de Sueldo Martinez Emiliano", "Ajuste de Sueldo Martinez Juan Jose", "Ajuste de Sueldo Palacios Omar", "Ajuste de Sueldo Ratto Andrea", "Ajuste de Sueldo Tapia Alberto", "Ajuste de Sueldo Ya√±ez Emanuel", "Anticipo de Sueldo Alcala Marcelo", "Anticipo de Sueldo Bayona Walter", "Anticipo de Sueldo Castilla Ezequiel", "Anticipo de Sueldo Castilla Luciano", "Anticipo de Sueldo Cayo Nestor", "Anticipo de Sueldo Gijon Valentin", "Anticipo de Sueldo Huberman Cesar", "Anticipo de Sueldo Lozada David", "Anticipo de Sueldo Lozada Marcela", "Anticipo de Sueldo Martinez Emiliano", "Anticipo de Sueldo Martinez Juan Jose", "Anticipo de Sueldo Palacios Omar", "Anticipo de Sueldo Ratto Andrea", "Anticipo de Sueldo Tapia Alberto", "Anticipo de Sueldo Ya√±ez Emanuel", "Atmosferico", "Combustible", "Comisiones", "Contenedrores", "Control de Plagas", "Descarga Palito Ma√≠z", "Descarga Papa Cruda", "Donaciones", "Electricidad", "Ferreter√≠a", "Flete Adolfo San Luis", "Flete Amoruso Mario San Luis", "Flete Cano Mario San Luis", "Flete Carallos Rodolfo", "Flete Escudero Benito", "Flete Esteban Emilio Malargue", "Flete Expreso Malargue", "Flete Fernadez Abel Alvear", "Flete Villegas Luis", "Flete Samo Alexis", "Flete Varas Leonardo Malargue", "Gastos Varios", "Honorarios Bromatologa", "Honorarios Contador", "Horas Extras Castilla Ezequiel", "Horas Extras Castilla Luciano", "Horas Extras Cayo Nestor", "Horas Extras Martinez Emiliano", "Horas Extras Palacios Omar", "Horas Extras Tapia Alberto", "Horas Extras Ya√±ez Emanuel", "Impuestos (Gas)", "Insumos Informaticos", "Internet", "Leyes Sociales", "Mandados Varios", "Mantenimiento Informaticos", "Mantenimiento Maquinarias", "Mantenimiento Veh√≠culos", "Mantenimientos Insumos Informaticos", "Multas", "Pago Az√∫car", "Pago Papa Cruda", "Pago Tostadas", "Patentes Veh√≠culos", "Plomeria", "Productos para Refrigerio Personal", "Productos de Librer√≠a", "Productos de Limpieza", "Publicidad", "Reposici√≥n Cheques Rechazados", "Retiro Basura", "Retiro Socio Chinarro Roberto", "Retiro Socio Gijon Gustavo", "Repuesto Maquinaria", "Seguros", "Sistema de alarma", "Soporte Sistema Discovery", "Sueldo Caba√±a Luciano", "Sueldo Chinarro Eliana", "Sueldo Gijon Andres", "Sueldo Gijon Eugenio", "Sueldo Gijon Francisco", "Sueldo Herrera Daniel", "Horas Extras Alcala Marcelo", "Agua Personal", "Agua Esencia de Vainilla", "Bienes de Uso para Dep√≥sito", "Anticipo de Sueldo Caba√±a Luciano", "Bascula (Pesada Papa)", "Bascula (Pesada Aceite)", "Cajas Usadas", "Gastos Coronel Suarez", "Materiales Varios", "Cinta de Embalar", "Horas Extras Lozada David", "Flete Maravilla", "Mantenimiento Deposito", "Instalaciones Tecnicas", "Insumos para el Personal", "Mantenimientos Varios", "Flete Cacho", "Pago Alquiler", "Flete Expreso Gonzalez", "Sueldo Castellano Alejo", "Anticipo de Sueldo Castellano Alejo", "Impuestos Municipal", "Prestamos", "Transferencia entre Cajas", "Servicio de Autoelevador", "Ropa de Trabajo", "Soda C√°ustica", "Faltante de Caja", "Muebles y Utiles", "Impuestos Varios", "Flete Amilcar", "Flete Vasca", "Imprenta", "Flete Maldonado", "Materia Prima", "Honorarios Seg. E Higiene", "Anticipo de Sueldo Tilleria Cristian", "Ajuste de Sueldo Tilleria Cristian", "Anticipo de Sueldo Arrieta Emanuel", "Ajuste de Sueldo Arrieta Emanuel", "Sueldo Gijon Ramiro", "Flete - Traslado Autoelevador", "Pallet usados", "Horas Extras Arrieta Emmanuel", "Horas Extras Tilleria Cristian", "Ajuste de Sueldo Rivero Lucas", "Anticipo de Sueldo Rivero Lucas", "Ajuste de Sueldo Solarza Facundo", "Anticipo de Sueldo Solarza Facundo", "Ajuste de Sueldo Arrienta Elian", "Anticipo de Sueldo Arrienta Elian", "Compra de D√≥lares", "STRECH", "Sueldo Rivero Lucas", "Sueldo Bastias Nicolas", "Pago Aguila & Aguila", "Salida a Banco", "Ajuste de Sueldo Bastias Nicolas", "Anticipo de Sueldo Bastias Nicolas", "Recambio Matafuego", "Metal√∫rgica Foksek Carlos", "Flete Fernandez Ricardo", "Flete Papa (Varios)", "Mantenimiento de Efluentes", "Pago Trival Snack S.R.L."];
        var registrosDiarios = {};
        var currentTypeMode = '';
        var selectedDropdownIndex = -1;

        // GUARDADO AUTOM√ÅTICO - Cargar datos al inicio
        function cargarDatosAutomatico() {
            try {
                var datosGuardados = localStorage.getItem('cajaProdugal');
                if (datosGuardados) {
                    var datos = JSON.parse(datosGuardados);
                    registrosDiarios = datos.registros || {};
                    if (datos.tiposIngreso) tiposIngreso = datos.tiposIngreso;
                    if (datos.tiposEgreso) tiposEgreso = datos.tiposEgreso;
                    console.log('‚úì Datos cargados autom√°ticamente');
                }
            } catch (e) {
                console.log('No hay datos previos');
            }
        }

        // GUARDADO AUTOM√ÅTICO - Guardar datos
        function guardarDatosAutomatico() {
            try {
                var datos = {
                    registros: registrosDiarios,
                    tiposIngreso: tiposIngreso,
                    tiposEgreso: tiposEgreso,
                    fecha: new Date().toISOString()
                };
                localStorage.setItem('cajaProdugal', JSON.stringify(datos));
                console.log('‚úì Datos guardados autom√°ticamente');
            } catch (e) {
                console.error('Error al guardar:', e);
            }
        }

        function formatCurrency(num) {
            var n = parseFloat(num || 0);
            var parts = Math.round(n).toString().split('');
            var resultado = '';
            var contador = 0;
            for (var i = parts.length - 1; i >= 0; i--) {
                if (contador > 0 && contador % 3 === 0) {
                    resultado = '.' + resultado;
                }
                resultado = parts[i] + resultado;
                contador++;
            }
            return '$' + resultado;
        }

        function parseCurrency(str) {
            return parseInt((str || '0').replace(/\$/g, '').replace(/\./g, '')) || 0;
        }

        function addIngreso() {
            var html = '<tr><td><div class="tipo-wrapper"><input type="text" class="tipo-search" placeholder="üîç Buscar tipo de ingreso..." autocomplete="off"><div class="tipo-dropdown" style="display:none;"></div></div></td>';
            html += '<td><input type="text" class="det" placeholder="Detalle"></td>';
            html += '<td><input type="text" class="efe" value="$0" inputmode="numeric"></td>';
            html += '<td><input type="text" class="tra" value="$0" inputmode="numeric"></td>';
            html += '<td><button class="btn-remove" onclick="this.parentNode.parentNode.remove(); calcularTotales();">X</button></td></tr>';
            
            var row = document.createElement('tr');
            row.innerHTML = html;
            document.getElementById('ingresosBody').appendChild(row);
            
            var input = row.querySelector('.tipo-search');
            var dropdown = row.querySelector('.tipo-dropdown');
            
            setupDropdownNavigation(input, dropdown, 'ingreso');
            
            row.querySelector('.efe').addEventListener('input', e => {
                var valor = e.target.value.replace(/[^\d]/g, '');
                e.target.value = formatCurrency(valor);
                calcularTotales();
            });
            row.querySelector('.tra').addEventListener('input', e => {
                var valor = e.target.value.replace(/[^\d]/g, '');
                e.target.value = formatCurrency(valor);
                calcularTotales();
            });
        }

        function addEgreso() {
            var html = '<tr><td><div class="tipo-wrapper"><input type="text" class="tipo-search" placeholder="üîç Buscar tipo de egreso..." autocomplete="off"><div class="tipo-dropdown" style="display:none;"></div></div></td>';
            html += '<td><input type="text" class="det" placeholder="Detalle"></td>';
            html += '<td><input type="text" class="efe" value="$0" inputmode="numeric"></td>';
            html += '<td><input type="text" class="tra" value="$0" inputmode="numeric"></td>';
            html += '<td><button class="btn-remove" onclick="this.parentNode.parentNode.remove(); calcularTotales();">X</button></td></tr>';
            
            var row = document.createElement('tr');
            row.innerHTML = html;
            document.getElementById('egresosBody').appendChild(row);
            
            var input = row.querySelector('.tipo-search');
            var dropdown = row.querySelector('.tipo-dropdown');
            
            setupDropdownNavigation(input, dropdown, 'egreso');
            
            row.querySelector('.efe').addEventListener('input', e => {
                var valor = e.target.value.replace(/[^\d]/g, '');
                e.target.value = formatCurrency(valor);
                calcularTotales();
            });
            row.querySelector('.tra').addEventListener('input', e => {
                var valor = e.target.value.replace(/[^\d]/g, '');
                e.target.value = formatCurrency(valor);
                calcularTotales();
            });
        }

        // NUEVA FUNCI√ìN: Configurar navegaci√≥n con flechas y Enter
        function setupDropdownNavigation(input, dropdown, tipo) {
            input.addEventListener('focus', () => { 
                selectedDropdownIndex = -1;
                actualizarDropdown(input, dropdown, tipo); 
            });
            
            input.addEventListener('input', () => { 
                selectedDropdownIndex = -1;
                actualizarDropdown(input, dropdown, tipo); 
            });
            
            input.addEventListener('blur', () => { 
                setTimeout(() => { 
                    dropdown.style.display = 'none'; 
                    selectedDropdownIndex = -1;
                }, 200); 
            });
            
            // NAVEGACI√ìN CON FLECHAS Y ENTER
            input.addEventListener('keydown', (e) => {
                var items = dropdown.querySelectorAll('.tipo-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (items.length > 0) {
                        selectedDropdownIndex = (selectedDropdownIndex + 1) % items.length;
                        updateDropdownSelection(items);
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (items.length > 0) {
                        selectedDropdownIndex = selectedDropdownIndex <= 0 ? items.length - 1 : selectedDropdownIndex - 1;
                        updateDropdownSelection(items);
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedDropdownIndex >= 0 && items[selectedDropdownIndex]) {
                        input.value = items[selectedDropdownIndex].textContent;
                        dropdown.style.display = 'none';
                        selectedDropdownIndex = -1;
                    }
                }
            });
        }

        function updateDropdownSelection(items) {
            items.forEach((item, idx) => {
                if (idx === selectedDropdownIndex) {
                    item.style.background = '#E3F2FD';
                    item.style.color = '#1565C0';
                    item.style.fontWeight = '500';
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.style.background = '';
                    item.style.color = '#333';
                    item.style.fontWeight = '';
                }
            });
        }

        function actualizarDropdown(input, dropdown, tipo) {
            var filter = input.value.toLowerCase();
            var tipos = (tipo === 'ingreso') ? tiposIngreso : tiposEgreso;
            var matches = tipos.filter(t => t.toLowerCase().includes(filter));
            
            dropdown.innerHTML = '';
            selectedDropdownIndex = -1;
            
            if (matches.length > 0) {
                matches.forEach(match => {
                    var item = document.createElement('div');
                    item.className = 'tipo-item';
                    item.textContent = match;
                    item.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        input.value = match;
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(item);
                });
                dropdown.style.display = 'block';
            } else if (filter) {
                var item = document.createElement('div');
                item.className = 'tipo-item-empty';
                item.textContent = 'No encontrado';
                dropdown.appendChild(item);
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function calcularTotales() {
            var totalIngEfe = 0, totalIngTrans = 0;
            document.querySelectorAll('#ingresosBody tr').forEach(row => {
                totalIngEfe += parseCurrency(row.querySelector('.efe').value);
                totalIngTrans += parseCurrency(row.querySelector('.tra').value);
            });
            var totalIng = totalIngEfe + totalIngTrans;
            
            var totalEgrEfe = 0, totalEgrTrans = 0;
            document.querySelectorAll('#egresosBody tr').forEach(row => {
                totalEgrEfe += parseCurrency(row.querySelector('.efe').value);
                totalEgrTrans += parseCurrency(row.querySelector('.tra').value);
            });
            var totalEgr = totalEgrEfe + totalEgrTrans;
            
            var totalTrans = totalIngTrans + totalEgrTrans;
            var efectivo = totalIngEfe - totalEgrEfe;
            
            document.getElementById('totalIngresos').textContent = formatCurrency(totalIng);
            document.getElementById('totalEgresos').textContent = formatCurrency(totalEgr);
            document.getElementById('resumenIngresos').textContent = formatCurrency(totalIng);
            document.getElementById('resumenEgresos').textContent = formatCurrency(totalEgr);
            document.getElementById('resumenTransferencias').textContent = formatCurrency(totalTrans);
            document.getElementById('efectivoFinal').textContent = formatCurrency(efectivo);
            
            var fecha = document.getElementById('fecha').value;
            registrosDiarios[fecha] = {ing: totalIng, egr: totalEgr, trans: totalTrans, efe: efectivo};
            
            // GUARDADO AUTOM√ÅTICO cada vez que cambian los totales
            guardarDatosAutomatico();
        }

        function openNewType(tipo) {
            currentTypeMode = tipo;
            document.getElementById('modalTitle').textContent = tipo === 'ingreso' ? 'Nuevo Tipo de Ingreso' : 'Nuevo Tipo de Egreso';
            document.getElementById('newTypeName').value = '';
            document.getElementById('newTypeModal').classList.add('active');
            document.getElementById('newTypeName').focus();
        }

        function crearNuevoTipo() {
            var nombre = document.getElementById('newTypeName').value.trim();
            if (!nombre) { alert('Ingresa un nombre'); return; }
            if (currentTypeMode === 'ingreso') {
                if (!tiposIngreso.includes(nombre)) { 
                    tiposIngreso.push(nombre); 
                    tiposIngreso.sort();
                    guardarDatosAutomatico(); // GUARDAR despu√©s de agregar tipo
                    alert('‚úì Tipo de ingreso agregado'); 
                } else { 
                    alert('Ya existe ese tipo'); 
                    return; 
                }
            } else {
                if (!tiposEgreso.includes(nombre)) { 
                    tiposEgreso.push(nombre); 
                    tiposEgreso.sort();
                    guardarDatosAutomatico(); // GUARDAR despu√©s de agregar tipo
                    alert('‚úì Tipo de egreso agregado'); 
                } else { 
                    alert('Ya existe ese tipo'); 
                    return; 
                }
            }
            closeModal();
        }

        function openDeleteType(tipo) {
            currentTypeMode = tipo;
            var select = document.getElementById('deleteTypeSelect');
            select.innerHTML = '<option value="">-- Seleccionar tipo a eliminar --</option>';
            var tipos = (tipo === 'ingreso') ? tiposIngreso : tiposEgreso;
            tipos.forEach(t => {
                var opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                select.appendChild(opt);
            });
            document.getElementById('modalDeleteTitle').textContent = tipo === 'ingreso' ? 'Eliminar Tipo de Ingreso' : 'Eliminar Tipo de Egreso';
            document.getElementById('deleteTypeModal').classList.add('active');
        }

        function eliminarTipo() {
            var select = document.getElementById('deleteTypeSelect');
            var nombre = select.value.trim();
            if (!nombre) { alert('Selecciona un tipo'); return; }
            if (currentTypeMode === 'ingreso') {
                var idx = tiposIngreso.indexOf(nombre);
                if (idx > -1) { 
                    tiposIngreso.splice(idx, 1);
                    guardarDatosAutomatico(); // GUARDAR despu√©s de eliminar tipo
                    alert('‚úì Tipo eliminado'); 
                } else { 
                    alert('No encontrado'); 
                    return; 
                }
            } else {
                var idx = tiposEgreso.indexOf(nombre);
                if (idx > -1) { 
                    tiposEgreso.splice(idx, 1);
                    guardarDatosAutomatico(); // GUARDAR despu√©s de eliminar tipo
                    alert('‚úì Tipo eliminado'); 
                } else { 
                    alert('No encontrado'); 
                    return; 
                }
            }
            closeDeleteModal();
        }

        function closeDeleteModal() {
            document.getElementById('deleteTypeModal').classList.remove('active');
        }

        function exportarExcelCaja() {
            var fecha = document.getElementById('fecha').value;
            var ingresos = [];
            var egresos = [];
            var totalIng = 0, totalEgr = 0, totalTrans = 0;
            
            document.querySelectorAll('#ingresosBody tr').forEach(row => {
                var tipo = row.querySelector('.tipo-search').value;
                var detalle = row.querySelector('.det').value;
                var efectivo = parseCurrency(row.querySelector('.efe').value);
                var transfer = parseCurrency(row.querySelector('.tra').value);
                if (tipo || detalle || efectivo > 0 || transfer > 0) {
                    ingresos.push({tipo, detalle, efectivo, transfer});
                    totalIng += efectivo + transfer;
                    totalTrans += transfer;
                }
            });
            
            document.querySelectorAll('#egresosBody tr').forEach(row => {
                var tipo = row.querySelector('.tipo-search').value;
                var detalle = row.querySelector('.det').value;
                var efectivo = parseCurrency(row.querySelector('.efe').value);
                var transfer = parseCurrency(row.querySelector('.tra').value);
                if (tipo || detalle || efectivo > 0 || transfer > 0) {
                    egresos.push({tipo, detalle, efectivo, transfer});
                    totalEgr += efectivo + transfer;
                    totalTrans += transfer;
                }
            });
            
            var html = '<html><head><meta charset="UTF-8"></head><body>';
            html += '<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; font-family: Arial; width: 100%;">';
            
            html += '<tr>';
            html += '<td colspan="4" style="background-color: #ADD8E6; text-align: center; font-weight: bold; font-size: 14px; padding: 10px;">CAJA DIARIA - PRODUGAL DUXELITOS</td>';
            html += '</tr>';
            html += '<tr>';
            html += '<td colspan="4" style="background-color: #ADD8E6; padding: 5px;">Fecha: ' + fecha + '</td>';
            html += '</tr>';
            html += '<tr>';
            html += '<td colspan="4" style="background-color: #ADD8E6; height: 5px;"></td>';
            html += '</tr>';
            
            html += '<tr>';
            html += '<td colspan="4" style="background-color: #90EE90; font-weight: bold; color: #333;">INGRESOS</td>';
            html += '</tr>';
            html += '<tr>';
            html += '<td style="background-color: #90EE90; font-weight: bold;">Tipo</td>';
            html += '<td style="background-color: #90EE90; font-weight: bold;">Detalle</td>';
            html += '<td style="background-color: #90EE90; font-weight: bold; text-align: center;">Monto Efectivo</td>';
            html += '<td style="background-color: #90EE90; font-weight: bold; text-align: center;">Monto Transferencia</td>';
            html += '</tr>';
            
            ingresos.forEach(ing => {
                html += '<tr>';
                html += '<td style="width: 25%;">' + ing.tipo + '</td>';
                html += '<td style="width: 25%;">' + ing.detalle + '</td>';
                html += '<td style="width: 25%; text-align: right;">$ ' + ing.efectivo.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '</td>';
                html += '<td style="width: 25%; text-align: right;">' + (ing.transfer > 0 ? '$ ' + ing.transfer.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : '') + '</td>';
                html += '</tr>';
            });
            
            html += '<tr>';
            html += '<td colspan="2" style="background-color: #90EE90; font-weight: bold;">TOTAL INGRESOS</td>';
            html += '<td colspan="2" style="background-color: #90EE90; font-weight: bold; text-align: right;">$ ' + totalIng.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '</td>';
            html += '</tr>';
            
            html += '<tr><td colspan="4" style="height: 5px;"></td></tr>';
            
            html += '<tr>';
            html += '<td colspan="4" style="background-color: #FFB6C1; font-weight: bold; color: #333;">EGRESOS</td>';
            html += '</tr>';
            html += '<tr>';
            html += '<td style="background-color: #FFB6C1; font-weight: bold;">Tipo</td>';
            html += '<td style="background-color: #FFB6C1; font-weight: bold;">Detalle</td>';
            html += '<td style="background-color: #FFB6C1; font-weight: bold; text-align: center;">Monto Efectivo</td>';
            html += '<td style="background-color: #FFB6C1; font-weight: bold; text-align: center;">Monto Transferencia</td>';
            html += '</tr>';
            
            egresos.forEach(egr => {
                html += '<tr>';
                html += '<td style="width: 25%;">' + egr.tipo + '</td>';
                html += '<td style="width: 25%;">' + egr.detalle + '</td>';
                html += '<td style="width: 25%; text-align: right;">$ ' + egr.efectivo.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '</td>';
                html += '<td style="width: 25%; text-align: right;">' + (egr.transfer > 0 ? '$ ' + egr.transfer.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : '') + '</td>';
                html += '</tr>';
            });
            
            html += '<tr>';
            html += '<td colspan="2" style="background-color: #FFB6C1; font-weight: bold;">TOTAL EGRESOS</td>';
            html += '<td colspan="2" style="background-color: #FFB6C1; font-weight: bold; text-align: right;">$ ' + totalEgr.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '</td>';
            html += '</tr>';
            
            html += '<tr><td colspan="4" style="height: 5px;"></td></tr>';
            
            html += '<tr>';
            html += '<td colspan="2" style="background-color: #ADD8E6; font-weight: bold;">TRANSFERENCIAS</td>';
            html += '<td colspan="2" style="background-color: #ADD8E6; text-align: right; font-weight: bold;">$ ' + totalTrans.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '</td>';
            html += '</tr>';
            
            var efectivoFinal = totalIng - totalEgr - totalTrans;
            html += '<tr>';
            html += '<td colspan="2" style="background-color: #ADD8E6; font-weight: bold;">EFECTIVO EN CAJA</td>';
            html += '<td colspan="2" style="background-color: #ADD8E6; text-align: right; font-weight: bold;">$ ' + efectivoFinal.toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + '</td>';
            html += '</tr>';
            
            html += '</table>';
            html += '</body></html>';
            
            var link = document.createElement('a');
            link.href = 'data:application/vnd.ms-excel;charset=UTF-8,' + encodeURIComponent(html);
            link.download = 'caja_diaria_' + fecha + '.xls';
            link.click();
        }

        function exportarExcelReportes() {
            var desde = document.getElementById('fechaDesde').value;
            var hasta = document.getElementById('fechaHasta').value;
            
            var tIng = 0, tEgr = 0, tTrans = 0;
            for (var f in registrosDiarios) {
                if (f >= desde && f <= hasta) {
                    var r = registrosDiarios[f];
                    tIng += r.ing;
                    tEgr += r.egr;
                    tTrans += r.trans;
                }
            }
            
            var html = '<table border="1" cellpadding="10" cellspacing="0" style="border-collapse: collapse; font-family: Arial;">';
            html += '<tr><td colspan="2" style="background-color: #87CEEB; text-align: center; font-size: 16px; font-weight: bold; color: white;">REPORTE DE CAJA - PRODUGAL DUXELITOS</td></tr>';
            html += '<tr><td colspan="2" style="background-color: #87CEEB; color: white;">Per√≠odo: ' + desde + ' al ' + hasta + '</td></tr>';
            html += '<tr><td colspan="2" style="background-color: #87CEEB;"></td></tr>';
            
            html += '<tr><td style="background-color: #87CEEB; color: white; font-weight: bold;">CONCEPTO</td><td style="background-color: #87CEEB; color: white; font-weight: bold; text-align: right;">MONTO</td></tr>';
            
            html += '<tr><td style="background-color: #4CAF50; color: white; font-weight: bold;">Total Ingresos</td><td style="background-color: #4CAF50; color: white; font-weight: bold; text-align: right;">$' + formatCurrency(tIng).replace('$', '') + '</td></tr>';
            
            html += '<tr><td style="background-color: #f44336; color: white; font-weight: bold;">Total Egresos</td><td style="background-color: #f44336; color: white; font-weight: bold; text-align: right;">$' + formatCurrency(tEgr).replace('$', '') + '</td></tr>';
            
            html += '<tr><td style="background-color: #FF9800; color: white; font-weight: bold;">Transferencias</td><td style="background-color: #FF9800; color: white; font-weight: bold; text-align: right;">$' + formatCurrency(tTrans).replace('$', '') + '</td></tr>';
            
            html += '<tr><td style="background-color: #87CEEB; color: white; font-weight: bold;">EFECTIVO EN CAJA</td><td style="background-color: #87CEEB; color: white; font-weight: bold; text-align: right;">$' + formatCurrency(tIng - tEgr - tTrans).replace('$', '') + '</td></tr>';
            
            html += '</table>';
            
            var link = document.createElement('a');
            link.href = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            link.download = 'reporte_' + desde + '_' + hasta + '.xls';
            link.click();
        }

        function closeModal() {
            document.getElementById('newTypeModal').classList.remove('active');
        }

        function generarReporte() {
            var desde = document.getElementById('fechaDesde').value;
            var hasta = document.getElementById('fechaHasta').value;
            if (!desde || !hasta) { alert('Selecciona fechas'); return; }
            
            var html = '<h3>üìä REPORTE DETALLADO</h3>';
            html += '<p style="color: #666; margin-bottom: 25px;">Per√≠odo: <strong>' + desde + '</strong> al <strong>' + hasta + '</strong></p>';
            
            html += '<h3 style="color: #4CAF50;">üí∞ INGRESOS</h3>';
            html += '<table><thead><tr><th>Fecha</th><th>Total Ingresos</th></tr></thead><tbody>';
            var tIng = 0;
            var hay = false;
            
            for (var f in registrosDiarios) {
                if (f >= desde && f <= hasta) {
                    hay = true;
                    var r = registrosDiarios[f];
                    html += '<tr><td>' + f + '</td><td>' + formatCurrency(r.ing) + '</td></tr>';
                    tIng += r.ing;
                }
            }
            if (hay) html += '<tr style="background: #E8F5E9; font-weight: bold;"><td>TOTAL INGRESOS</td><td>' + formatCurrency(tIng) + '</td></tr>';
            html += '</tbody></table>';
            
            html += '<br><h3 style="color: #f44336;">üí∏ EGRESOS</h3>';
            html += '<table><thead><tr><th>Fecha</th><th>Total Egresos</th></tr></thead><tbody>';
            var tEgr = 0;
            
            for (var f in registrosDiarios) {
                if (f >= desde && f <= hasta) {
                    var r = registrosDiarios[f];
                    html += '<tr><td>' + f + '</td><td>' + formatCurrency(r.egr) + '</td></tr>';
                    tEgr += r.egr;
                }
            }
            if (hay) html += '<tr style="background: #FFEBEE; font-weight: bold;"><td>TOTAL EGRESOS</td><td>' + formatCurrency(tEgr) + '</td></tr>';
            html += '</tbody></table>';
            
            var tTrans = 0;
            for (var f in registrosDiarios) {
                if (f >= desde && f <= hasta) {
                    var r = registrosDiarios[f];
                    tTrans += r.trans || 0;
                }
            }
            
            html += '<br><h3>üìã RESUMEN FINAL DEL PER√çODO</h3>';
            html += '<table><thead><tr><th>Concepto</th><th>Monto</th></tr></thead><tbody>';
            html += '<tr style="background: #E8F5E9;"><td>Total Ingresos</td><td>' + formatCurrency(tIng) + '</td></tr>';
            html += '<tr style="background: #FFEBEE;"><td>Total Egresos</td><td>' + formatCurrency(tEgr) + '</td></tr>';
            html += '<tr style="background: #FFF3E0;"><td>Transferencias</td><td>' + formatCurrency(tTrans) + '</td></tr>';
            html += '<tr style="background: linear-gradient(135deg, #1565C0 0%, #42A5F5 100%); color: white; font-weight: bold; font-size: 16px;"><td>EFECTIVO EN CAJA</td><td>' + formatCurrency(tIng - tEgr - tTrans) + '</td></tr>';
            html += '</tbody></table>';
            
            if (!hay) document.getElementById('reporteContainer').innerHTML = '<p style="text-align: center; color: #999;">No hay datos para el per√≠odo seleccionado</p>';
            else document.getElementById('reporteContainer').innerHTML = html;
        }

        document.getElementById('btnLogin').addEventListener('click', () => {
            // CARGAR DATOS AUTOM√ÅTICAMENTE al iniciar
            cargarDatosAutomatico();
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            var hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = hoy;
            document.getElementById('fechaDesde').value = hoy;
            document.getElementById('fechaHasta').value = hoy;
            addIngreso();
            addEgreso();
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            if (confirm('¬øSeguro que quer√©s cerrar sesi√≥n? Los datos est√°n guardados autom√°ticamente.')) {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                var id = 'tab' + tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1);
                document.getElementById(id).classList.add('active');
            });
        });

        document.getElementById('btnBackup').addEventListener('click', () => {
            var datos = JSON.stringify({
                registros: registrosDiarios, 
                tiposIngreso: tiposIngreso,
                tiposEgreso: tiposEgreso,
                fecha: new Date().toISOString()
            }, null, 2);
            var link = document.createElement('a');
            link.href = 'data:text/json,' + encodeURIComponent(datos);
            link.download = 'backup_caja_' + new Date().getTime() + '.json';
            link.click();
            alert('‚úì Backup descargado correctamente');
        });

        document.getElementById('btnLoadBackup').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            var reader = new FileReader();
            reader.onload = (event) => {
                try {
                    var datos = JSON.parse(event.target.result);
                    registrosDiarios = datos.registros || {};
                    if (datos.tiposIngreso) tiposIngreso = datos.tiposIngreso;
                    if (datos.tiposEgreso) tiposEgreso = datos.tiposEgreso;
                    guardarDatosAutomatico(); // Guardar despu√©s de cargar backup
                    alert('‚úì Backup cargado correctamente');
                    calcularTotales();
                } catch (err) {
                    alert('Error al cargar el archivo');
                }
            };
            reader.readAsText(e.target.files[0]);
        });
    </script>
</body>
</html>
